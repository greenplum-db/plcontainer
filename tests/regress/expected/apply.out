drop type if exists add_one_input;
NOTICE:  type "add_one_input" does not exist, skipping
create type add_one_input as (
    i int
);
create or replace function add_one_for_apply(_ add_one_input[])
returns setof record as $$
# container: plc_python_user
for row in _:
    yield {"i": row["i"] + 1}
$$ language plcontainer;
-- batch size == 0
select * 
from plcontainer_apply(
    table(select generate_series(1, 10)), 'add_one_for_apply', 0
) as (i int);
ERROR:  plcontainer: batch size must be > 0. (plcontainer.c:817)
-- data size % batch size == 0
select * 
from plcontainer_apply(
    table(select generate_series(1, 10)), 'add_one_for_apply', 1
) as (i int);
 i  
----
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
(10 rows)

-- data size % batch size == 1
select * 
from plcontainer_apply(
    table(select generate_series(1, 10)), 'add_one_for_apply', 3
) as (i int);
 i  
----
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
(10 rows)

-- data size % batch size != 0 and != 1
select * 
from plcontainer_apply(
    table(select generate_series(1, 10)), 'add_one_for_apply', 4
) as (i int);
 i  
----
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
(10 rows)

-- bulk transmitting >= 1 GB data
create or replace view "1gb_text" as (
    select repeat('a', 1 << 20) as a from generate_series(1, 1 << 10)
);
create or replace function echo_for_apply(arg_records "1gb_text"[])
returns setof record as $$
# container: plc_python_user
for row in arg_records:
    yield row
$$ language plcontainer;
-- should throw an ERROR when using array_agg()
select echo_for_apply(array_agg("1gb_text")) from "1gb_text";
ERROR:  array size exceeds the maximum allowed (1073741823)
-- no ERROR when using plcontainer_apply()
select count(*)
from plcontainer_apply(
    table(table "1gb_text"), 'echo_for_apply', 10
) as (a text);
 count 
-------
  1024
(1 row)


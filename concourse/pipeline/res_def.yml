resource_types:
- name: gcs
  type: registry-image
  check_every: 1h
  source:
    repository: frodenas/gcs-resource

- name: pull-request
  type: docker-image
  check_every: 1h
  source:
    repository: teliaoss/github-pr-resource

- name: slack-alert
  type: docker-image
  source:
    repository: arbourd/concourse-slack-alert-resource

resources:
# Pull Request
- name: plcontainer_pr
  type: pull-request
  # We should rely on the webhook. See README if webhook doesn't work
  webhook_token: ((extension/extensions-webhook-token))
  check_every: 24h
  source:
    disable_forks: false
    repository: greenplum-db/plcontainer
    access_token: ((extension/github-access-token))
    base_branch: 6X_STABLE

# Commit trigger
- name: plcontainer_commit
  type: git
  # We should rely on the webhook. See README if webhook doesn't work
  webhook_token: ((extension/extensions-webhook-token))
  check_every: 1h
  source:
    branch: ((plcontainer-branch))
    uri: https://github.com/greenplum-db/plcontainer
    username: ((extension/github-access-token))
    password: x-oauth-basic
    ignore_paths:
      - README.md
      - README_PG.md
# Commit dev trigger. Not using webhook
- name: plcontainer_commit_dev
  type: git
  check_every: 1m
  source:
    branch: ((plcontainer-branch))
    uri: https://github.com/greenplum-db/plcontainer
    username: ((extension/github-access-token))
    password: x-oauth-basic
    ignore_paths:
      - README.md
      - README_PG.md

# Commit dev trigger. Not using webhook
- name: plcontainer_release
  type: git
  check_every: 2h
  source:
    branch: hy/ubuntu_test 
    uri: https://github.com/greenplum-db/plcontainer
    username: ((github-access-token))
    password: x-oauth-basic
    paths:
      - dockerfiles/*
      - CMakelists.txt
      - concourse/*
    ignore_paths:
      - README.md
      - README_PG.md

# Greenplum sources
- name: gpdb6_src
  type: git
  source:
    branch: 6X_STABLE
    uri: https://github.com/greenplum-db/gpdb.git

# Image Resources
# centos6
- name: centos6-gpdb6-image-build
  type: registry-image
  source:
    repository: gcr.io/data-gpdb-public-images/gpdb6-centos6-build
    tag: latest
- name: centos6-gpdb6-image-test
  type: registry-image
  source:
    repository: gcr.io/data-gpdb-public-images/gpdb6-centos6-test
    tag: latest
# centos7
- name: centos7-gpdb6-image-build
  type: registry-image
  source:
    repository: gcr.io/data-gpdb-public-images/gpdb6-centos7-build
    tag: latest
- name: centos7-gpdb6-image-test
  type: registry-image
  source:
    repository: gcr.io/data-gpdb-public-images/gpdb6-centos7-test
    tag: latest
# rhel8
- name: rhel8-gpdb6-image-build
  type: registry-image
  source:
    repository: gcr.io/data-gpdb-private-images/gpdb6-rhel8-build
    tag: latest
    username: _json_key
    password: ((data-gpdb-private-images-container-registry-readonly-service-account-key))
- name: rhel8-gpdb6-image-test
  type: registry-image
  source:
    repository: gcr.io/data-gpdb-private-images/gpdb6-rhel8-test
    tag: latest
    username: _json_key
    password: ((data-gpdb-private-images-container-registry-readonly-service-account-key))
# Ubuntu18
- name: ubuntu18-gpdb6-image-build
  type: registry-image
  source:
    repository: gcr.io/data-gpdb-public-images/gpdb6-ubuntu18.04-build
    tag: latest
- name: ubuntu18-gpdb6-image-test
  type: registry-image
  source:
    repository: gcr.io/data-gpdb-public-images/gpdb6-ubuntu18.04-test
    tag: latest

# gpdb binary on gcs is located as different folder for different version
# Latest build with assertion enabled:
# --enable-cassert --enable-tap-tests --enable-debug-extensions
- name: bin_gpdb6_centos6_debug
  type: gcs
  source:
    bucket: pivotal-gpdb-concourse-resources-prod
    json_key: ((concourse-gcs-resources-service-account-key))
    regexp: server/published/gpdb6/server-rc-(.*)-rhel6_x86_64.debug.tar.gz
- name: bin_gpdb6_centos7_debug
  type: gcs
  source:
    bucket: pivotal-gpdb-concourse-resources-prod
    json_key: ((concourse-gcs-resources-service-account-key))
    regexp: server/published/gpdb6/server-rc-(.*)-rhel7_x86_64.debug.tar.gz
- name: bin_gpdb6_rhel8_debug
  type: gcs
  source:
    bucket: pivotal-gpdb-concourse-resources-prod
    json_key: ((concourse-gcs-resources-service-account-key))
    regexp: server/published/gpdb6/server-rc-(.*)-rhel8_x86_64.debug.tar.gz
- name: bin_gpdb6_ubuntu18_debug
  type: gcs
  source:
    bucket: pivotal-gpdb-concourse-resources-prod
    json_key: ((concourse-gcs-resources-service-account-key))
    regexp: server/published/gpdb6/server-rc-(.*)-ubuntu18.04_x86_64.debug.tar.gz
# Latest release candidates, no fault-injector, no assertion:
# --disable-debug-extensions --disable-tap-tests --enable-ic-proxy
- name: bin_gpdb6_centos6
  type: gcs
  source:
    bucket: pivotal-gpdb-concourse-resources-prod
    json_key: ((concourse-gcs-resources-service-account-key))
    regexp: server/published/gpdb6/server-rc-(.*)-rhel6_x86_64.tar.gz
- name: bin_gpdb6_centos7
  type: gcs
  source:
    bucket: pivotal-gpdb-concourse-resources-prod
    json_key: ((concourse-gcs-resources-service-account-key))
    regexp: server/published/gpdb6/server-rc-(.*)-rhel7_x86_64.tar.gz
- name: bin_gpdb6_rhel8
  type: gcs
  source:
    bucket: pivotal-gpdb-concourse-resources-prod
    json_key: ((concourse-gcs-resources-service-account-key))
    regexp: server/published/gpdb6/server-rc-(.*)-rhel8_x86_64.tar.gz
- name: bin_gpdb6_ubuntu18
  type: gcs
  source:
    bucket: pivotal-gpdb-concourse-resources-prod
    json_key: ((concourse-gcs-resources-service-account-key))
    regexp: server/published/gpdb6/server-rc-(.*)-ubuntu18.04_x86_64.tar.gz

# For uploading every build to gcs
- name: bin_plcontainer_gpdb6_rhel7_intermediates
  type: gcs
  source:
    bucket: gpdb-extensions-concourse-resources
    json_key: ((extension/extensions-gcs-service-account-key))
    versioned_file: intermediates/plcontainer/plcontainer_rhel7_gpdb6.gppkg

- name: bin_plcontainer_gpdb6_rhel6_intermediates
  type: gcs
  source:
    bucket: gpdb-extensions-concourse-resources
    json_key: ((extension/extensions-gcs-service-account-key))
    versioned_file: intermediates/plcontainer/plcontainer_rhel6_gpdb6.gppkg

- name: bin_plcontainer_gpdb6_rhel8_intermediates
  type: gcs
  source:
    bucket: gpdb-extensions-concourse-resources
    json_key: ((extension/extensions-gcs-service-account-key))
    versioned_file: intermediates/plcontainer/plcontainer_rhel8_gpdb6.gppkg

- name: bin_plcontainer_gpdb6_ubuntu18_intermediates
  type: gcs
  source:
    bucket: gpdb-extensions-concourse-resources
    json_key: ((extension/extensions-gcs-service-account-key))
    versioned_file: intermediates/plcontainer/plcontainer_ubuntu18_gpdb6.gppkg

- name: tar_plcontainer_python3_docker_intermediates_python39_alpine
  type: gcs
  source:
    bucket: gpdb-extensions-concourse-resources
    json_key: ((extensions-gcs-service-account-key))
    versioned_file: intermediates/plcontainer/plcontainer_python3_shared.tar.gz

- name: tar_plcontainer_python3_docker_intermediates_python39_ubuntu2004_b
  type: gcs
  source:
    bucket: gpdb-extensions-concourse-resources
    json_key: ((extensions-gcs-service-account-key))
    versioned_file: intermediates/plcontainer/plcontainer_python39_ubuntu2004_bundle_shared.tar.gz

- name: tar_plcontainer_python3_docker_intermediates_python37_ubuntu1804_b
  type: gcs
  source:
    bucket: gpdb-extensions-concourse-resources
    json_key: ((extensions-gcs-service-account-key))
    versioned_file: intermediates/plcontainer/plcontainer_python37_ubuntu1804_bundle_shared.tar.gz

- name: tar_plcontainer_r_docker_intermediates
  type: gcs
  source:
    bucket: gpdb-extensions-concourse-resources
    json_key: ((extensions-gcs-service-account-key))
    versioned_file: intermediates/plcontainer/plcontainer_r_shared.tar.gz

- name: tar_plcontainer_r_docker_intermediates_bundle
  type: gcs
  source:
    bucket: gpdb-extensions-concourse-resources
    json_key: ((extensions-gcs-service-account-key))
    versioned_file: intermediates/plcontainer/plcontainer_r_bundle_shared.tar.gz

# For uploading to the release bucket
- name: bin_plcontainer_gpdb6_rhel7_release
  type: gcs
  source:
    bucket: pivotal-gpdb-concourse-resources-prod
    json_key: ((concourse-gcs-resources-service-account-key))
    regexp: plcontainer/released/gpdb6/plcontainer-(.*).gppkg

- name: bin_plcontainer_gpdb6_rhel8_release
  type: gcs
  source:
    bucket: pivotal-gpdb-concourse-resources-prod
    json_key: ((concourse-gcs-resources-service-account-key))
    regexp: plcontainer/released/gpdb6/plcontainer-(.*).gppkg

- name: bin_plcontainer_gpdb6_ubuntu18_release
  type: gcs
  source:
    bucket: pivotal-gpdb-concourse-resources-prod
    json_key: ((concourse-gcs-resources-service-account-key))
    regexp: plcontainer/released/gpdb6/plcontainer-(.*).gppkg

# Other dependencies
- name: bin_cmake
  type: gcs
  source:
    bucket: gpdb-extensions-concourse-resources
    json_key: ((extension/extensions-gcs-service-account-key))
    regexp: dependencies/cmake-(.*)-linux-x86_64.sh

- name: slack_notify
  type: slack-alert
  source:
    url: ((extension/extensions-slack-webhook))
